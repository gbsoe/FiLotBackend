TRANCHE T6.B â€” BACKEND SECURITY & DOMAIN FINALIZATION PATCH (FOR REPLIT AGENT)

*(FiLot Backend Workspace Only â€” Do NOT run in frontend repo)*

## ðŸŽ¯ **Objectives of This Patch**

This tranche will implement the following:

### 1ï¸âƒ£ Add strict CORS with real frontend domain

* Allow ONLY: `https://app.filot.id`
* Block everything else
* Include secure headers and allowed service-key header

### 2ï¸âƒ£ Add secure internal service-key validator

Used for:

* FiLot â†” Buli2 hybrid verification route
* Admin internal routes in the future

### 3ï¸âƒ£ Add presigned download URLs for R2 (prevent PII leakage)

* Disable public access to KTP/NPWP files
* Create **signed download endpoint**

### 4ï¸âƒ£ Add rate limiting

* Prevent brute-force
* Prevent abusive uploads/processing

### 5ï¸âƒ£ Add middlewares folder cleanup & refactor

* `corsConfig.ts`
* `verifyServiceKey.ts`
* `rateLimiter.ts`
* Update `app.ts` to use all
* Do NOT break existing OCR or upload API

---

# ðŸš€ **REPLIT AGENT â€” EXECUTE THE FOLLOWING**

## ðŸ”§ **Step 1 â€” Create new env variables (do NOT hardcode)**

Add to `.env`:

```
FILOT_FRONTEND_ORIGIN=https://app.filot.id
SERVICE_INTERNAL_KEY=sk_live_REPLACE_WITH_RANDOM_64_CHAR
R2_PRIVATE_URL_EXPIRY=3600
```

If `.env` already has similar keys, update only values.

---

## ðŸ”§ **Step 2 â€” Install dependency for rate limiting**

Run:

```
npm install express-rate-limit
```

---

## ðŸ”§ **Step 3 â€” Create new middleware folder and files**

### âž¤ Create: `src/middleware/corsConfig.ts`

```ts
import cors from "cors";

export const corsConfig = cors({
  origin: process.env.FILOT_FRONTEND_ORIGIN,
  methods: ["GET", "POST", "PUT", "PATCH", "DELETE"],
  allowedHeaders: ["Content-Type", "Authorization", "x-service-key"],
  credentials: true,
});
```

---

### âž¤ Create: `src/middleware/verifyServiceKey.ts`

```ts
export function verifyServiceKey(req, res, next) {
  const key = req.headers["x-service-key"];

  if (!key || key !== process.env.SERVICE_INTERNAL_KEY) {
    return res.status(403).json({ error: "Forbidden: Invalid service key" });
  }

  next();
}
```

---

### âž¤ Create: `src/middleware/rateLimiter.ts`

```ts
import rateLimit from "express-rate-limit";

export const rateLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 minute
  max: 60, // 60 requests per minute per IP
  message: { error: "Too many requests. Please try again later." },
});
```

---

## ðŸ”§ **Step 4 â€” Update R2 storage service to support presigned URLs**

Modify `src/services/r2Storage.ts`:

Add:

```ts
import { getSignedUrl } from "@aws-sdk/s3-request-presigner";
import { GetObjectCommand } from "@aws-sdk/client-s3";

export async function generatePresignedUrl(key: string) {
  const command = new GetObjectCommand({
    Bucket: process.env.CF_R2_BUCKET_NAME,
    Key: key,
  });

  return await getSignedUrl(s3Client, command, {
    expiresIn: Number(process.env.R2_PRIVATE_URL_EXPIRY || 3600),
  });
}
```

---

## ðŸ”§ **Step 5 â€” Create secure endpoint for signed downloads**

Add file: `src/routes/downloadRoutes.ts`

```ts
import { Router } from "express";
import { generatePresignedUrl } from "../services/r2Storage";
import { authRequired } from "../middleware/authMiddleware";

const router = Router();

router.get("/:id", authRequired, async (req, res) => {
  try {
    const { id } = req.params;

    const document = await req.db.query.documents.findFirst({
      where: (d, { eq }) => eq(d.id, id),
    });

    if (!document) {
      return res.status(404).json({ error: "Document not found" });
    }

    // Authorization: user can only access own document
    if (document.userId !== req.user.id) {
      return res.status(403).json({ error: "Forbidden" });
    }

    const fileKey = document.fileUrl.replace(/^.*r2\.cloudflarestorage\.com\//, "");

    const signedUrl = await generatePresignedUrl(fileKey);

    res.json({ url: signedUrl });
  } catch (err) {
    console.error("Presigned URL error:", err);
    res.status(500).json({ error: "Failed to generate secure URL" });
  }
});

export default router;
```

---

## ðŸ”§ **Step 6 â€” Register all new middlewares & download route in `src/app.ts`**

Modify `app.ts`:

```ts
import { corsConfig } from "./middleware/corsConfig";
import { rateLimiter } from "./middleware/rateLimiter";

app.use(corsConfig);
app.use(rateLimiter);

import downloadRoutes from "./routes/downloadRoutes";
app.use("/documents/secure-download", downloadRoutes);
```

---

# ðŸ“˜ **EXPECTED OUTPUT FROM REPLIT AGENT**

The agent should:

âœ” Create new middleware files
âœ” Update R2 storage service
âœ” Add secure download route
âœ” Update `app.ts` to apply strict CORS + rate limiting
âœ” Add env variable placeholders
âœ” Ensure existing OCR/upload endpoints keep working
âœ” NOT break the hybrid verification architecture
âœ” NOT touch frontend repository

---

# ðŸ“„ **DOCUMENTATION TO GENERATE (AGENT SHOULD WRITE FILE)**

Create file:

```
/docs/T6B_BACKEND_SECURITY_PATCH.md
```

Contains:

âœ” CORS rules
âœ” Service-key protection rules
âœ” Signed URL flow
âœ” Rate limiter configuration
âœ” Security test instructions
