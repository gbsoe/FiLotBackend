TRANCHE 6 â€” HYBRID VERIFICATION ARCHITECTURE (BACKEND IMPLEMENTATION)
FiLot Backend â€” For Replit Agent Execution
(Do NOT modify frontend files. Do NOT create frontend screens.)
________________________________________
ðŸŽ¯ OBJECTIVE
Implement the Hybrid Verification EngineÂ inside FiLot backend so that:
ðŸ”¹ OCR â†’ Local AI Scoring â†’ Hybrid Decision â†’ Buli2 Escalation
After OCR completes, system generates a confidence score
If score above thresholdÂ â†’ auto-verified
If score below thresholdÂ â†’ escalate to Buli2 Manual Review Queue
System prepares Buli2-ready verification payloads
Add compatibility layer for future Temporal WorkflowsÂ (but no Temporal usage yet)
________________________________________
===============================
ðŸ“¦ 1. DATABASE CHANGES
===============================
Create a new migration:
A. Add fields to documentsÂ table
Add:
ALTER TABLE documents
 Â ADD COLUMN ai_score NUMERIC(5,2),
 Â ADD COLUMN verification_status VARCHAR(50) DEFAULT 'pending', -- pending | auto_verified | needs_manual_review | manually_verified | rejected
 Â ADD COLUMN buli2_ticket_id VARCHAR(255),
 Â ADD COLUMN processed_at TIMESTAMP;

________________________________________
===============================
ðŸ¤– 2. AI SCORING LOGIC
===============================
Create a new file:
backend/src/verification/aiScoring.ts
Implement simple rule-based scoring (for now using heuristics):
export function computeAIScore(type: 'KTP' | 'NPWP', parsed: any): number {
 Â let score = 0;

 Â // Basic completeness rules
 Â if (!parsed) return 0;

 Â const fields = Object.values(parsed).filter(Boolean);
 Â const completeness = fields.length / Object.keys(parsed).length;
 Â score += completeness * 60;

 Â // Format rules
 Â if (type === 'KTP') {
 Â  Â if (/^\d{16}$/.test(parsed.nik || '')) score += 20;
 Â  Â if (parsed.name?.length > 3) score += 10;
 Â }

 Â if (type === 'NPWP') {
 Â  Â if (/^\d{2}\.\d{3}\.\d{3}\.\d{1}-\d{3}\.\d{3}$/.test(parsed.npwpNumber || '')) {
 Â  Â  Â score += 30;
 Â  Â }
 Â }

 Â // Clamp score
 Â return Math.min(100, Math.round(score));
}

________________________________________
===============================
âš–ï¸ 3. HYBRID DECISION ENGINE
===============================
Create:
backend/src/verification/hybridEngine.ts
Logic:
import { computeAIScore } from './aiScoring';

export function determineVerificationPath(type, parsedResult) {
 Â const score = computeAIScore(type, parsedResult);

 Â if (score >= 75) {
 Â  Â return { outcome: 'auto_verified', score };
 Â }

 Â return { outcome: 'needs_manual_review', score };
}

This integrates into your OCR pipeline.
________________________________________
===============================
ðŸ”„ 4. MODIFY OCR PROCESSOR
===============================
Modify file:
backend/src/ocr/processor.ts
After parsing:
import { determineVerificationPath } from '../verification/hybridEngine';
import { db } from '../db';

const { outcome, score } = determineVerificationPath(doc.type, parsedData);

await db.update(documents)
 Â .set({
 Â  Â ai_score: score,
 Â  Â verification_status: outcome,
 Â  Â processed_at: new Date()
 Â })
 Â .where(eq(documents.id, documentId));

________________________________________
===============================
ðŸ“¤ 5. BULI2 ESCALATION PIPELINE
===============================
Create new directory:
backend/src/buli2/
Files:
________________________________________
A. buli2Client.ts
Contains â€œfuture-proofâ€ client for Buli2 API (currently mocked):
export async function sendToBuli2(document, parsedData, aiScore) {
 Â // TODO: replace with real URL later
 Â console.log("Mock: Sending document to Buli2 queue");

 Â return {
 Â  Â ticketId: `BULI2-${Date.now()}`,
 Â  Â status: 'queued'
 Â };
}

________________________________________
B. escalationService.ts
import { sendToBuli2 } from './buli2Client';
import { db } from '../db';
import { documents } from '../db/schema';

export async function escalateToBuli2(document, parsed, score) {
 Â const result = await sendToBuli2(document, parsed, score);

 Â await db.update(documents)
 Â  Â .set({
 Â  Â  Â buli2_ticket_id: result.ticketId,
 Â  Â  Â verification_status: 'needs_manual_review'
 Â  Â })
 Â  Â .where(eq(documents.id, document.id));

 Â return result;
}

________________________________________
===============================
ðŸš€ 6. ADD NEW ENDPOINTS
===============================
File:

backend/src/routes/verificationRoutes.ts
Endpoints:
________________________________________
1. GET /verification/:documentId/status
Return:
{
 Â "verificationStatus": "pending | auto_verified | needs_manual_review | manually_verified | rejected",
 Â "aiScore": 82,
 Â "buli2TicketId": "BULI2-1231231"
}

________________________________________
2. POST /verification/:documentId/escalate
Triggers manual escalation to Buli2 queue.
________________________________________
===============================
ðŸ§© 7. HOOK INTO OCR PROCESSING
===============================
Inside processor.ts, after OCR â†’ parsing:
if (outcome === "needs_manual_review") {
 Â  await escalateToBuli2(doc, parsedData, score);
}

________________________________________
===============================
ðŸ”® 8. TEMPORAL-READY DESIGN (SCaffolding Only)
===============================
Create:
backend/src/temporal/workflowsStub.ts
This does NOT run Temporal yet. It simply prepares the structure:
// Future: these will be connected to real Temporal workflows

export const TemporalWorkflows = {
 Â startVerificationWorkflow: async (documentId) => {
 Â  Â console.log("Temporal stub: starting workflow for", documentId);
 Â },

 Â notifyBuli2ManualReview: async (ticketId) => {
 Â  Â console.log("Temporal stub: notify Buli2", ticketId);
 Â }
};

No external services, no workers.

Just architecture compatibility.
________________________________________
===============================
ðŸ”§ 9. UPDATE APP ENTRYPOINT
===============================
In backend/src/app.ts:
Add:
import verificationRoutes from './routes/verificationRoutes';
app.use('/verification', verificationRoutes);

________________________________________
===============================
ðŸ§ª 10. TEST FLOW CHECKLIST
===============================
After OCR completes:
Auto Verified (Score â‰¥ 75)
verification_status = "auto_verified"
no escalation
no Buli2 ticket
Needs Manual Review (Score < 75)
verification_status = "needs_manual_review"
Buli2 ticket ID generated
Data logged for future Buli2 integration
No frontend modifications required.
________________________________________
===============================
âœ… WHAT REPLIT AGENT MUST DO
===============================
When running this prompt, the agent must:
âœ”ï¸ Create all new directories and files exactly as listed
âœ”ï¸ Add new DB migration
âœ”ï¸ Modify OCR processor
âœ”ï¸ Implement hybrid scoring engine
âœ”ï¸ Add verification routes
âœ”ï¸ Add escalation pipeline
âœ”ï¸ Add Temporal stubs
âœ”ï¸ Ensure NO frontend files are touched
âœ”ï¸ Ensure backend compiles after changes